<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draft Modal Test</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Draft Modal Test</h2>
        <p>This test verifies that the draft modal works correctly without getting stuck with a blackened screen.</p>
        
        <button class="btn btn-primary" onclick="testModal()">
            <i class="fas fa-edit me-2"></i>Test Draft Modal
        </button>
        
        <div class="mt-3">
            <h4>Test Steps:</h4>
            <ol>
                <li>Click "Test Draft Modal" to open the modal</li>
                <li>Click "Delete" on any draft item</li>
                <li>Confirm the deletion</li>
                <li>Verify the modal refreshes without getting stuck</li>
                <li>Close the modal and verify no blackened screen remains</li>
            </ol>
        </div>
    </div>

    <!-- Draft Requests Modal -->
    <div class="modal fade" id="draftRequestsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-edit me-2"></i>
                        Taslak Talepler (Test)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Test Modal:</strong> This is a test modal to verify the fix for the blackened screen issue.
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="draft-requests-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Talep No</th>
                                    <th>Başlık</th>
                                    <th>Oluşturulma</th>
                                    <th>Malzeme Sayısı</th>
                                    <th>Tedarikçi Sayısı</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="draft-requests-tbody">
                                <!-- Test data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="draft-requests-empty" style="display: none;">
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Taslak talep bulunamadı</h5>
                            <p class="text-muted">Henüz kaydedilmiş taslak talebiniz bulunmamaktadır.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Test data
        let testDrafts = [
            {
                id: 1,
                title: 'Test Draft 1',
                created_at: new Date().toISOString(),
                data: { items: [1, 2], suppliers: [1] }
            },
            {
                id: 2,
                title: 'Test Draft 2',
                created_at: new Date().toISOString(),
                data: { items: [1], suppliers: [1, 2] }
            }
        ];

        function testModal() {
            showDraftRequestsModal();
        }

        async function showDraftRequestsModal() {
            const tbody = document.getElementById('draft-requests-tbody');
            const emptyDiv = document.getElementById('draft-requests-empty');
            const table = document.getElementById('draft-requests-table');
            
            if (!testDrafts || testDrafts.length === 0) {
                table.style.display = 'none';
                emptyDiv.style.display = 'block';
            } else {
                table.style.display = 'table';
                emptyDiv.style.display = 'none';
                
                tbody.innerHTML = testDrafts.map(draft => `
                    <tr>
                        <td>
                            <span class="fw-bold text-primary">${draft.id}</span>
                        </td>
                        <td>${draft.title || 'Başlıksız'}</td>
                        <td>${formatDate(draft.created_at)}</td>
                        <td>${draft.data?.items?.length || 0}</td>
                        <td>${draft.data?.suppliers?.length || 0}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary btn-sm" onclick="editDraft(${draft.id})">
                                    <i class="fas fa-edit me-1"></i>Düzenle
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteDraftRequest(${draft.id})">
                                    <i class="fas fa-trash me-1"></i>Sil
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Show the modal - check for existing instance first
            const modalElement = document.getElementById('draftRequestsModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            
            // If no existing instance, create a new one
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            
            // Ensure any existing backdrop is removed
            const existingBackdrop = document.querySelector('.modal-backdrop');
            if (existingBackdrop) {
                existingBackdrop.remove();
            }
            
            // Remove any modal-open class from body
            document.body.classList.remove('modal-open');
            
            modal.show();
        }

        async function deleteDraftRequest(draftId) {
            try {
                // Show confirmation dialog
                if (!confirm('Bu taslağı silmek istediğinizden emin misiniz?')) {
                    return;
                }
                
                // Remove the draft from test data
                testDrafts = testDrafts.filter(draft => draft.id !== draftId);
                
                // Show success notification
                alert('Taslak başarıyla silindi!');
                
                // Refresh the modal to show updated list
                // First, close the current modal instance if it exists
                const modalElement = document.getElementById('draftRequestsModal');
                const existingModal = bootstrap.Modal.getInstance(modalElement);
                if (existingModal) {
                    existingModal.hide();
                }
                
                // Wait a bit for the modal to close, then refresh
                setTimeout(async () => {
                    await showDraftRequestsModal();
                }, 150);
                
            } catch (error) {
                console.error('Error deleting draft request:', error);
                alert('Taslak silinirken hata oluştu: ' + error.message);
            }
        }

        function editDraft(draftId) {
            alert(`Editing draft ${draftId} - This is just a test!`);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialize modal cleanup
        document.addEventListener('DOMContentLoaded', function() {
            const draftModal = document.getElementById('draftRequestsModal');
            if (draftModal) {
                draftModal.addEventListener('hidden.bs.modal', function() {
                    // Clean up any remaining backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                    // Remove modal-open class from body
                    document.body.classList.remove('modal-open');
                });
            }
        });
    </script>
</body>
</html>
