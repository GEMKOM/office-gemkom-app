<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merge Functionality Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Malzeme Birleştirme Fonksiyonu Test</h1>
    
    <div class="test-section">
        <h2>Test Senaryosu</h2>
        <p>Aşağıdaki malzemelerin birleştirilmesi test edilecek:</p>
        <table>
            <thead>
                <tr>
                    <th>Kod</th>
                    <th>Ad</th>
                    <th>İş No</th>
                    <th>Miktar</th>
                    <th>Birim</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>F014</td>
                    <td>LAZER KESİM</td>
                    <td>RM262-04-04</td>
                    <td>25</td>
                    <td>ADET</td>
                </tr>
                <tr>
                    <td>F014</td>
                    <td>LAZER KESİM</td>
                    <td>RM262-04-04</td>
                    <td>15</td>
                    <td>ADET</td>
                </tr>
                <tr>
                    <td>F014</td>
                    <td>LAZER KESİM</td>
                    <td>5715</td>
                    <td>75</td>
                    <td>ADET</td>
                </tr>
                <tr>
                    <td>F014</td>
                    <td>LAZER KESİM</td>
                    <td>5715</td>
                    <td>25</td>
                    <td>ADET</td>
                </tr>
            </tbody>
        </table>
    </div>

         <div class="test-section">
         <h2>Beklenen Sonuç</h2>
         <p>Birleştirme sonrası 1 satır olmalı (allocations ile):</p>
         <table>
             <thead>
                 <tr>
                     <th>Kod</th>
                     <th>Ad</th>
                     <th>İş No</th>
                     <th>Miktar</th>
                     <th>Birim</th>
                     <th>Allocations</th>
                 </tr>
             </thead>
             <tbody>
                 <tr>
                     <td>F014</td>
                     <td>LAZER KESİM</td>
                     <td>RM262-04-04 (25.00), 5715 (100.00)</td>
                     <td>140</td>
                     <td>ADET</td>
                     <td>2 allocations</td>
                 </tr>
             </tbody>
         </table>
         <p><strong>JSON Format:</strong></p>
         <pre>{
  "code": "F014",
  "name": "LAZER KESİM", 
  "unit": "ADET",
  "quantity": "140.00",
  "allocations": [
    {"job_no": "RM262-04-04", "quantity": "40.00"},
    {"job_no": "5715", "quantity": "100.00"}
  ]
}</pre>
     </div>

    <div class="test-section">
        <h2>Test Sonucu</h2>
        <div id="test-result">Test çalıştırılıyor...</div>
    </div>

    <script type="module">
        // Mock ItemsManager class for testing
        class MockItemsManager {
            constructor() {
                this.requestData = {
                    items: [
                        {
                            id: 1,
                            code: "F014",
                            name: "LAZER KESİM",
                            job_no: "RM262-04-04",
                            quantity: 25,
                            unit: "ADET",
                            specs: "Test specs 1"
                        },
                        {
                            id: 2,
                            code: "F014",
                            name: "LAZER KESİM",
                            job_no: "RM262-04-04",
                            quantity: 15,
                            unit: "ADET",
                            specs: "Test specs 2"
                        },
                        {
                            id: 3,
                            code: "F014",
                            name: "LAZER KESİM",
                            job_no: "5715",
                            quantity: 75,
                            unit: "ADET",
                            specs: "Test specs 3"
                        },
                        {
                            id: 4,
                            code: "F014",
                            name: "LAZER KESİM",
                            job_no: "5715",
                            quantity: 25,
                            unit: "ADET",
                            specs: "Test specs 4"
                        }
                    ]
                };
            }

            findItemIndexByCodeAndNameAndJobNo(code, name, jobNo) {
                return this.requestData.items.findIndex(item => 
                    item.code.trim().toLowerCase() === code.trim().toLowerCase() &&
                    item.name.trim().toLowerCase() === name.trim().toLowerCase() &&
                    (item.job_no || '').trim().toLowerCase() === (jobNo || '').trim().toLowerCase()
                );
            }

            getSpecsFromOriginalItem(code, name, jobNo) {
                const itemIndex = this.findItemIndexByCodeAndNameAndJobNo(code, name, jobNo);
                if (itemIndex !== -1) {
                    return this.requestData.items[itemIndex].specs || '';
                }
                return '';
            }

            mergeSpecs(specsArray) {
                const allSpecs = specsArray
                    .filter(specs => specs && specs.trim())
                    .map(specs => specs.trim())
                    .join(' | ')
                    .split(' | ')
                    .filter((spec, index, array) => array.indexOf(spec) === index)
                    .join(' | ');
                
                return allSpecs;
            }

            // Simulate the merge process
            simulateMerge() {
                // Group items by code
                const groupedByCode = {};
                this.requestData.items.forEach((item, index) => {
                    const code = item.code.trim().toLowerCase();
                    if (!groupedByCode[code]) {
                        groupedByCode[code] = [];
                    }
                    groupedByCode[code].push({ ...item, originalIndex: index });
                });

                // Find groups with multiple items
                const duplicates = Object.entries(groupedByCode)
                    .filter(([code, items]) => items.length > 1)
                    .map(([code, items]) => ({ code, items }));

                if (duplicates.length === 0) {
                    return { success: false, message: 'Birleştirilecek aynı kodlu malzeme bulunamadı.' };
                }

                const mergedItems = [];
                const itemsToRemove = [];

                duplicates.forEach(({ code, items }) => {
                    // Check if all items have the same name and unit
                    const firstItem = items[0];
                    const sameName = items.every(item => 
                        item.name.trim().toLowerCase() === firstItem.name.trim().toLowerCase()
                    );
                    const sameUnit = items.every(item => 
                        item.unit.trim().toLowerCase() === firstItem.unit.trim().toLowerCase()
                    );

                    if (!sameName || !sameUnit) {
                        return { success: false, message: 'Farklı ad veya birim bulundu.' };
                    }

                                 // Group items by job_no and sum quantities for each job number
             const jobNoAllocations = {};
             items.forEach(item => {
                 const jobNo = item.job_no || '';
                 if (!jobNoAllocations[jobNo]) {
                     jobNoAllocations[jobNo] = 0;
                 }
                 jobNoAllocations[jobNo] += parseFloat(item.quantity || 0);
             });

             // Create a single merged item with allocations
             const totalQuantity = items.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
             const allocations = Object.entries(jobNoAllocations).map(([jobNo, quantity]) => ({
                 job_no: jobNo,
                 quantity: quantity.toFixed(2)
             }));

             const mergedItem = {
                 id: items[0].id,
                 code: items[0].code,
                 name: items[0].name,
                 job_no: '', // Will be empty since we're using allocations
                 quantity: totalQuantity,
                 unit: items[0].unit,
                 specs: this.mergeSpecs(items.map(item => item.specs)),
                 allocations: allocations // Add allocations array
             };

             mergedItems.push(mergedItem);
             itemsToRemove.push(...items.map(item => item.originalIndex));
                });

                return { success: true, mergedItems, itemsToRemove };
            }
        }

        // Run test
        function runTest() {
            const itemsManager = new MockItemsManager();
            const result = itemsManager.simulateMerge();
            
            const testResult = document.getElementById('test-result');
            
            if (!result.success) {
                testResult.innerHTML = `
                    <div class="error">
                        <h3>❌ Test Başarısız!</h3>
                        <p>${result.message}</p>
                    </div>
                `;
                return;
            }

                         const expected = {
                 code: "F014", 
                 name: "LAZER KESİM", 
                 job_no: "", 
                 quantity: 140, 
                 unit: "ADET",
                 allocations: [
                     { job_no: "RM262-04-04", quantity: "40.00" },
                     { job_no: "5715", quantity: "100.00" }
                 ]
             };

             // Check if the result matches expected format
             const isSuccess = 
                 result.mergedItems.length === 1 &&
                 result.mergedItems[0].code === expected.code &&
                 result.mergedItems[0].name === expected.name &&
                 result.mergedItems[0].job_no === expected.job_no &&
                 result.mergedItems[0].quantity === expected.quantity &&
                 result.mergedItems[0].unit === expected.unit &&
                 result.mergedItems[0].allocations &&
                 result.mergedItems[0].allocations.length === expected.allocations.length &&
                 result.mergedItems[0].allocations.every((allocation, index) => 
                     allocation.job_no === expected.allocations[index].job_no &&
                     allocation.quantity === expected.allocations[index].quantity
                 );

            if (isSuccess) {
                                 testResult.innerHTML = `
                     <div class="success">
                         <h3>✅ Test Başarılı!</h3>
                         <p>Malzemeler başarıyla birleştirildi. Farklı iş numaraları tek bir satırda allocations olarak birleştirildi.</p>
                         <h4>Birleştirme Sonucu:</h4>
                         <table>
                             <thead>
                                 <tr>
                                     <th>Kod</th>
                                     <th>Ad</th>
                                     <th>İş No</th>
                                     <th>Miktar</th>
                                     <th>Birim</th>
                                     <th>Allocations</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 ${result.mergedItems.map(item => `
                                     <tr>
                                         <td>${item.code}</td>
                                         <td>${item.name}</td>
                                         <td>${item.allocations ? item.allocations.map(a => `${a.job_no} (${a.quantity})`).join(', ') : item.job_no}</td>
                                         <td>${item.quantity}</td>
                                         <td>${item.unit}</td>
                                         <td>${item.allocations ? item.allocations.length + ' allocations' : 'None'}</td>
                                     </tr>
                                 `).join('')}
                             </tbody>
                         </table>
                         <h4>JSON Format:</h4>
                         <pre>${JSON.stringify(result.mergedItems[0], null, 2)}</pre>
                         <h4>Silinecek Satırlar:</h4>
                         <p>${result.itemsToRemove.length} satır silinecek (indeksler: ${result.itemsToRemove.join(', ')})</p>
                     </div>
                 `;
            } else {
                testResult.innerHTML = `
                    <div class="error">
                        <h3>❌ Test Başarısız!</h3>
                        <p>Beklenen sonuç ile gerçek sonuç uyuşmuyor.</p>
                        <h4>Beklenen:</h4>
                        <pre>${JSON.stringify(expected, null, 2)}</pre>
                        <h4>Gerçek:</h4>
                        <pre>${JSON.stringify(result.mergedItems, null, 2)}</pre>
                    </div>
                `;
            }
        }

        // Run test when page loads
        runTest();
    </script>
</body>
</html>
