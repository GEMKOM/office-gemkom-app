<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Password Reset Flow - Gemkom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Password Reset Flow Test</h1>
        
        <div class="test-section">
            <h3>Test 1: Check shouldBeOnResetPasswordPage function</h3>
            <button id="test-reset-page-check" class="btn btn-primary">Test Reset Page Check</button>
            <div id="test-reset-page-result"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 2: Simulate password reset scenario</h3>
            <button id="test-password-reset" class="btn btn-primary">Simulate Password Reset</button>
            <div id="test-password-reset-result"></div>
        </div>
        
        <div class="test-section">
            <h3>Test 3: Check localStorage state</h3>
            <button id="check-localstorage" class="btn btn-secondary">Check LocalStorage</button>
            <div id="localstorage-result"></div>
        </div>
        
        <div class="test-section">
            <h3>Current User State</h3>
            <div id="current-state"></div>
        </div>
    </div>

    <script type="module">
        import { shouldBeOnResetPasswordPage, mustResetPassword, isLoggedIn, getUser } from '../../authService.js';
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }
        
        function updateCurrentState() {
            const stateDiv = document.getElementById('current-state');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const isLoggedInStatus = isLoggedIn();
            const mustReset = mustResetPassword();
            const shouldBeOnReset = shouldBeOnResetPasswordPage();
            
            stateDiv.innerHTML = `
                <div class="test-result info">
                    <strong>Current State:</strong><br>
                    Is Logged In: ${isLoggedInStatus}<br>
                    Must Reset Password: ${mustReset}<br>
                    Should Be On Reset Page: ${shouldBeOnReset}<br>
                    User Data: <pre>${JSON.stringify(user, null, 2)}</pre>
                </div>
            `;
        }
        
        // Test 1: Check shouldBeOnResetPasswordPage function
        document.getElementById('test-reset-page-check').addEventListener('click', () => {
            try {
                const result = shouldBeOnResetPasswordPage();
                showResult('test-reset-page-result', 
                    `shouldBeOnResetPasswordPage() returned: ${result}`, 
                    result ? 'error' : 'success'
                );
            } catch (error) {
                showResult('test-reset-page-result', 
                    `Error: ${error.message}`, 
                    'error'
                );
            }
        });
        
        // Test 2: Simulate password reset scenario
        document.getElementById('test-password-reset').addEventListener('click', () => {
            try {
                // Simulate a user who needs to reset password
                const testUser = {
                    id: 1,
                    username: 'testuser',
                    must_reset_password: true,
                    team: 'machining'
                };
                
                localStorage.setItem('user', JSON.stringify(testUser));
                localStorage.setItem('accessToken', 'test-token');
                localStorage.setItem('refreshToken', 'test-refresh-token');
                
                showResult('test-password-reset-result', 
                    'Simulated user with must_reset_password=true. Check current state.', 
                    'info'
                );
                
                updateCurrentState();
            } catch (error) {
                showResult('test-password-reset-result', 
                    `Error: ${error.message}`, 
                    'error'
                );
            }
        });
        
        // Test 3: Check localStorage state
        document.getElementById('check-localstorage').addEventListener('click', () => {
            const user = localStorage.getItem('user');
            const accessToken = localStorage.getItem('accessToken');
            const refreshToken = localStorage.getItem('refreshToken');
            
            showResult('localstorage-result', 
                `User: ${user || 'null'}<br>
                 Access Token: ${accessToken ? 'Present' : 'Missing'}<br>
                 Refresh Token: ${refreshToken ? 'Present' : 'Missing'}`, 
                'info'
            );
        });
        
        // Update state on page load
        updateCurrentState();
        
        // Update state every 2 seconds
        setInterval(updateCurrentState, 2000);
    </script>
</body>
</html>
