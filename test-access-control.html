<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Control Test - GEMKOM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .access-granted {
            color: #198754;
        }
        .access-denied {
            color: #dc3545;
        }
        .team-info {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Access Control Test Page</h1>
        
        <div class="team-info">
            <h5>Current User Information</h5>
            <div id="user-info">Loading...</div>
        </div>

        <div class="test-section">
            <h4>Route Access Tests</h4>
            <div id="route-tests">Loading...</div>
        </div>

        <div class="test-section">
            <h4>Feature Access Tests</h4>
            <div id="feature-tests">Loading...</div>
        </div>

        <div class="test-section">
            <h4>Navigation Filtering Test</h4>
            <div id="navigation-test">Loading...</div>
        </div>

        <div class="test-section">
            <h4>Team Simulation</h4>
            <p>Test different team configurations:</p>
            <div class="btn-group mb-3" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('admin')">Admin</button>
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('management')">Management</button>
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('manufacturing')">Manufacturing</button>
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('machining')">Machining</button>
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('maintenance')">Maintenance</button>
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('procurement')">Procurement</button>
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('finance')">Finance</button>
                <button type="button" class="btn btn-outline-primary" onclick="simulateTeam('other')">Other</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { hasRouteAccess, hasSectionAccess, getAccessibleRoutes, filterNavigationByAccess } from './apis/accessControl.js';
        import { canAccessFeature } from './apis/routeProtection.js';
        import { getUser } from './authService.js';

        // Test routes
        const testRoutes = [
            '/',
            '/general/users',
            '/general/machines',
            '/general/overtime',
            '/manufacturing/machining/dashboard',
            '/manufacturing/maintenance/fault-requests',
            '/manufacturing/welding',
            '/procurement/purchase-requests',
            '/procurement/suppliers',
            '/finance/purchase-orders',
            '/finance/reports/executive-overview'
        ];

        // Test features
        const testFeatures = [
            'create_user',
            'edit_user',
            'delete_user',
            'view_finance',
            'edit_finance',
            'view_procurement',
            'edit_procurement',
            'view_manufacturing',
            'edit_manufacturing',
            'view_overtime',
            'edit_overtime'
        ];

        // Navigation structure for testing
        const testNavigation = {
            '/general': {
                label: 'Genel',
                icon: 'fas fa-cogs',
                children: {
                    '/general/users': {
                        label: 'Çalışanlar',
                        icon: 'fas fa-users',
                        children: {}
                    },
                    '/general/machines': {
                        label: 'Makineler',
                        icon: 'fas fa-cogs',
                        children: {}
                    }
                }
            },
            '/manufacturing': {
                label: 'İmalat',
                icon: 'fas fa-industry',
                children: {
                    '/manufacturing/machining': {
                        label: 'Torna',
                        icon: 'fas fa-cog',
                        children: {}
                    },
                    '/manufacturing/maintenance': {
                        label: 'Bakım',
                        icon: 'fas fa-wrench',
                        children: {}
                    }
                }
            }
        };

        function displayUserInfo() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userInfoDiv = document.getElementById('user-info');
                userInfoDiv.innerHTML = `
                    <strong>Username:</strong> ${user.username || 'N/A'}<br>
                    <strong>Name:</strong> ${user.first_name || ''} ${user.last_name || ''}<br>
                    <strong>Team:</strong> ${user.team || 'other'}<br>
                    <strong>Is Admin:</strong> ${user.is_admin || false}
                `;
            } catch (error) {
                document.getElementById('user-info').innerHTML = 'Error loading user info';
            }
        }

        function displayRouteTests() {
            const routeTestsDiv = document.getElementById('route-tests');
            let html = '<div class="row">';
            
            testRoutes.forEach(route => {
                const hasAccess = hasRouteAccess(route);
                const accessClass = hasAccess ? 'access-granted' : 'access-denied';
                const accessIcon = hasAccess ? 'fa-check' : 'fa-times';
                
                html += `
                    <div class="col-md-6 mb-2">
                        <i class="fas ${accessIcon} ${accessClass}"></i>
                        <code>${route}</code>
                    </div>
                `;
            });
            
            html += '</div>';
            routeTestsDiv.innerHTML = html;
        }

        function displayFeatureTests() {
            const featureTestsDiv = document.getElementById('feature-tests');
            let html = '<div class="row">';
            
            testFeatures.forEach(feature => {
                const hasAccess = canAccessFeature(feature);
                const accessClass = hasAccess ? 'access-granted' : 'access-denied';
                const accessIcon = hasAccess ? 'fa-check' : 'fa-times';
                
                html += `
                    <div class="col-md-6 mb-2">
                        <i class="fas ${accessIcon} ${accessClass}"></i>
                        <code>${feature}</code>
                    </div>
                `;
            });
            
            html += '</div>';
            featureTestsDiv.innerHTML = html;
        }

        function displayNavigationTest() {
            const navigationTestDiv = document.getElementById('navigation-test');
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userTeam = user.team || 'other';
                const filteredNav = filterNavigationByAccess(testNavigation, userTeam);
                
                let html = '<h6>Original Navigation:</h6><pre>' + JSON.stringify(testNavigation, null, 2) + '</pre>';
                html += '<h6>Filtered Navigation for team "' + userTeam + '":</h6><pre>' + JSON.stringify(filteredNav, null, 2) + '</pre>';
                
                navigationTestDiv.innerHTML = html;
            } catch (error) {
                navigationTestDiv.innerHTML = 'Error testing navigation filtering';
            }
        }

        function runAllTests() {
            displayUserInfo();
            displayRouteTests();
            displayFeatureTests();
            displayNavigationTest();
        }

        // Global function for team simulation
        window.simulateTeam = function(team) {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                user.team = team;
                localStorage.setItem('user', JSON.stringify(user));
                runAllTests();
            } catch (error) {
                alert('Error simulating team: ' + error.message);
            }
        };

        // Initialize tests
        runAllTests();
    </script>
</body>
</html>
